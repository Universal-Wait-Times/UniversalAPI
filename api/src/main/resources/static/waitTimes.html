<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Universal Orlando Wait Times</title>
    <script data-goatcounter="https://themeparkstickets.goatcounter.com/count"
            async src="//gc.zgo.at/count.js"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 20px;
            background: #f4f4f4;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
            text-align: center;
        }

        .tabs {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 8px 16px;
            background: #ddd;
            border-radius: 9999px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s, color 0.2s;
        }

        .tab.active {
            background: #4CAF50;
            color: white;
        }

        .hours {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .ride {
            background: white;
            padding: 14px 16px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ride-name {
            font-weight: bold;
            font-size: 16px;
        }

        .wait {
            font-weight: bold;
            font-size: 16px;
        }

        .updated {
            text-align: center;
            margin-top: 20px;
            color: gray;
            font-size: 14px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Universal Orlando Wait Times</h1>
    <div class="tabs" id="tabs"></div>
    <div class="hours" id="hours">Loading park hours...</div>
    <div id="rides">Loading...</div>
    <div class="updated" id="updated"></div>
</div>

<script>
    const WAIT_API = 'https://themeparks.matthewe.me/api/v1/attractions/UOR';
    const HOURS_API_BASE = 'https://themeparks.matthewe.me/api/v1/parks/hours/uor/';
    const parks = ['UEU', 'USF', 'IOA'];
    let currentPark = 'UEU';
    let allData = [];

    const keyMap = {
        "UEU": "Epic",
        "USF": "Studios",
        "IOA": "Islands",
    }

    function setActiveTab(park) {
        currentPark = park;
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.park === park);
        });
        renderRides();
        fetchParkHours();
    }

    function renderTabs() {
        const tabsContainer = document.getElementById('tabs');
        parks.forEach(park => {
            const tab = document.createElement('div');
            tab.className = 'tab';
            tab.dataset.park = park;
            tab.textContent = keyMap[park];
            tab.onclick = () => setActiveTab(park);
            if (park === currentPark) tab.classList.add('active');
            tabsContainer.appendChild(tab);
        });
    }
     function extractLocalHourFromISOString(dateTimeStr) {
        const date = new Date(dateTimeStr); // Parses the ISO string and applies local timezone
        let hours = date.getHours();
        const minutes = date.getMinutes();

        const period = hours >= 12 ? "PM" : "AM";
        hours = hours % 12 || 12; // Convert to 12-hour format

        return `${hours}${minutes === 0 ? '' : `:${minutes.toString().padStart(2, '0')}`} ${period}`;
    }
    function getWaitColor(mins) {
        if (mins <= 25) return 'green';
        if (mins < 60) return 'orange';
        return 'red';
    }
    function getWaitPriority(standby) {
        if (!standby || !standby.status) return { priority: 99, wait: 0 };

        switch (standby.status) {
            case 'OPEN':
                return { priority: 0, wait: standby.wait_time || standby.display_wait_time || 0 };
            case 'WALK_ON':
                return { priority: 1, wait: 0 };
            case 'BRIEF_DELAY':
                return { priority: 2, wait: 0 };
            case 'OPENS_AT':
                return { priority: 3, wait: 0 };
            case 'CLOSED':
                return { priority: 4, wait: 0 };
            case 'UNKNOWN':
            default:
                return { priority: 5, wait: 0 };
        }
    }



    function renderRides() {
        const container = document.getElementById('rides');
        container.innerHTML = '';

        const filtered = allData.filter(a => a.park === currentPark);

        filtered.sort((a, b) => {
            const getStandby = ride => ride.queues?.find(q => q.queue_type === 'STANDBY') || null;
            const standbyA = getStandby(a);
            const standbyB = getStandby(b);

            const priA = getWaitPriority(standbyA);
            const priB = getWaitPriority(standbyB);

            if (priA.priority !== priB.priority) {
                return priA.priority - priB.priority;
            } else {
                return priB.wait - priA.wait; // Sort descending by wait time
            }
        });


        let anyShown = false;

        filtered.forEach(attraction => {
            if (attraction.name==="Hogwarts™ Express - Last Train") return;
            if (attraction.name==="Raptor Encounter") return;
            if (attraction.name==="Hogwarts™ Express - First Train") return;
            const standby = attraction.queues?.find(q => q.queue_type === 'STANDBY');

            if (!standby) return; // Skip if no standby

            let displayWaitTime = '';
            let waitColor ;

            if (standby.status === 'OPEN') {
                displayWaitTime = standby.display_wait_time + " minutes";
                waitColor = getWaitColor(standby.display_wait_time);
            } else if (standby.status === 'BRIEF_DELAY') {
                displayWaitTime = 'Brief Delay';
                waitColor = 'red';
            } else if (standby.status === 'WALK_ON') {
                displayWaitTime = 'Walk ON';
                waitColor = 'green';
            } else if (standby.status === 'OPENS_AT') {

                let time =   extractLocalHourFromISOString(standby.opens_at);
                displayWaitTime = "Opens At: " + time;
                console.log(standby);
                waitColor = 'dark_gray';
            } else {
                displayWaitTime = standby.status ;
                waitColor = 'green';
            }

            if (standby.status === 'CLOSED' && attraction.name==="E.T. Adventure™") {
                displayWaitTime = "Closed — Back June 14";

                waitColor = 'red';
            }
            const div = document.createElement('div');
            div.className = 'ride';
            div.innerHTML = `
            <span class="ride-name">${attraction.name}</span>
            <span class="wait" style="color:${waitColor}">${displayWaitTime}</span>
        `;
            container.appendChild(div);
            anyShown = true;
        });

        if (!anyShown) {
            container.textContent = 'No open attractions found.';
        }
    }


    async function fetchWaitTimes() {
        try {
            const response = await fetch(WAIT_API);
            allData = await response.json();
            renderRides();
            document.getElementById('updated').textContent =
                'Last updated: ' + new Date().toLocaleTimeString();
        } catch {
            document.getElementById('rides').textContent = 'Failed to load wait times.';
        }
    }

    async function fetchParkHours() {
        const today = new Date();
        const dateKey = today.toISOString().split('T')[0];
        const [year, month, day] = dateKey.split('-');
        const formattedDate = `${month}-${day}-${year}`;
        const url = `${HOURS_API_BASE}${currentPark}/${formattedDate}`;

        try {
            const res = await fetch(url);
            const hoursData = await res.json();
            let hours = hoursData[formattedDate]?.ReadableString || 'Hours not available';

            const hourObject = hoursData[formattedDate];

            if (hourObject['EarlyEntryString']) {
                const early =  extractLocalHourFromISOString(hourObject['EarlyEntryString']);
                hours += ` <span style="font-weight: bold;">| Early Admission: ${early}</span>`;
            }

            console.log(hoursData);
            document.getElementById('hours').innerHTML = `Park Hours: ${hours}`;
        } catch {
            document.getElementById('hours').textContent = 'Failed to load park hours.';
        }

    }

    renderTabs();
    fetchWaitTimes();
    fetchParkHours();
    setInterval(fetchWaitTimes, 5000);
    setInterval(fetchParkHours, 60000);
</script>
</body>
<footer style="text-align: center; padding: 0.25em 0; font-size: 0.9em; background-color: #f2f2f2; color: #333;">
    <p>© 2025 ThemeParks.Matthewe.me — All rights reserved.</p>
    <p>This website is an independent fan project and is not affiliated with, endorsed by, or officially connected to Universal Parks & Resorts or any of its subsidiaries.</p>
</footer>

</html>
